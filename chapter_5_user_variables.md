## 第五章：使用者自訂變數詳解 (Chapter 5: User-Defined Variables Explained)

Excel Monitor 旨在提供高度的靈活性和可配置性，以適應不同的監控需求和運行環境。這主要通過 `config/settings.py` 文件中定義的一系列使用者可自訂變數來實現。這些變數就像是系統的「開關」和「旋鈕」，允許您精確地調整其行為。理解這些變數的作用、它們如何影響系統性能和功能，對於有效部署和優化系統至關重要。

### 5.1 變更追蹤相關：定義「有意義的變更」

這些變數控制系統如何識別和記錄不同類型的 Excel 儲存格變更。它們幫助系統區分哪些變更是您真正關心的，哪些是您可以忽略的「噪音」。

*   **`TRACK_EXTERNAL_REFERENCES`** (布林值, 預設 `True`)
    *   **作用**：控制系統是否追蹤 Excel 儲存格中**外部參照 (External References)** 的變更。當一個公式引用了另一個 Excel 檔案中的儲存格時（例如 `=SUM([銷售數據.xlsx]Sheet1!A1:A10)`），如果該外部檔案的內容發生變化，導致本檔案中引用該外部參照的儲存格值發生變化，系統是否將其視為一個「有意義的變更」並記錄。
    *   **詳細解釋**：在複雜的企業環境中，Excel 檔案之間經常存在相互連結。一個主報表可能從多個數據源檔案中提取數據。如果 `TRACK_EXTERNAL_REFERENCES` 為 `True`，系統不僅會監控本檔案的直接變更，還會追溯到外部數據源的變化對本檔案的影響。這對於建立完整的數據血緣（Data Lineage）和理解數據流動至關重要。
    *   **建議**：
        *   如果您的 Excel 檔案之間存在複雜的連結關係，且需要追蹤這些跨檔案的資料流動，或者您需要進行嚴格的數據審計，請務必保持 `True`。
        *   如果您的 Excel 檔案都是獨立的，或者您只關心檔案內部的直接變更，可以設定為 `False` 以減少日誌量和處理複雜度。

*   **`TRACK_DIRECT_VALUE_CHANGES`** (布林值, 預設 `True`)
    *   **作用**：控制系統是否追蹤儲存格中**直接輸入數值**的變更。例如，將儲存格 A1 的值從 `100` 直接修改為 `200`，或者將文本從 `"舊名稱"` 修改為 `"新名稱"`。
    *   **詳細解釋**：這是最基本、最常見的變更類型，代表了使用者對數據的直接修改。
    *   **建議**：這是數據審計的核心，通常應保持 `True` 以確保完整的變更追蹤。除非您有非常特殊的需求，否則不建議關閉。

*   **`TRACK_FORMULA_CHANGES`** (布林值, 預設 `True`)
    *   **作用**：控制系統是否追蹤儲存格中**公式本身**的變更。例如，將儲存格 B1 的公式從 `=A1+A2` 修改為 `=SUM(A1:A3)`。
    *   **詳細解釋**：公式是 Excel 檔案中業務邏輯的體現。公式的變更意味著計算規則或數據處理邏輯的改變。追蹤公式變更對於理解業務規則的演變、發現潛在的計算錯誤或舞弊行為至關重要。
    *   **建議**：公式變更是 Excel 檔案中最高價值的變更之一，通常應保持 `True`。

*   **`IGNORE_INDIRECT_CHANGES`** (布林值, 預設 `True`)
    *   **作用**：控制系統是否忽略**間接變更**。間接變更指的是儲存格的公式沒有變化，但由於其引用的其他儲存格（在同一個檔案內）的值發生變化，導致該儲存格的計算結果也隨之變化。例如，儲存格 C1 的公式是 `=A1+B1`。如果 A1 的值從 10 變為 20，那麼 C1 的值也會隨之變化，但 C1 的公式本身並沒有變。
    *   **詳細解釋**：如果 `IGNORE_INDIRECT_CHANGES` 為 `True`，系統會認為 C1 的變化是 A1 變化的「結果」，而不是一個獨立的、需要記錄的「原因」。這樣可以顯著減少日誌中的「噪音」，使日誌更聚焦於數據變化的「根本原因」。
    *   **建議**：
        *   在大多數情況下，您可能只關心直接的輸入或公式變更，而間接變更只是這些直接變更的結果。將此設定為 `True` 可以使日誌更簡潔、更易於分析。
        *   如果您需要追蹤所有計算結果的變化，例如在某些嚴格的數據一致性審計場景下，則可以設定為 `False`。但請注意，這會導致日誌量大幅增加。

### 5.2 效能與資源相關：優化系統運行效率

這些變數影響系統的運行效率、資源消耗以及對不同檔案大小的適應性。它們幫助系統在性能和資源佔用之間找到最佳平衡點。

*   **`POLLING_SIZE_THRESHOLD_MB`** (整數, 預設 `10`)
    *   **作用**：定義了 Excel 檔案大小的閾值（單位：MB），用於區分「小型檔案」和「大型檔案」，進而影響輪詢策略。
    *   **詳細解釋**：這是智慧輪詢策略的基礎。系統會根據檔案大小，動態選擇密集輪詢或稀疏輪詢。這個閾值決定了「小型」和「大型」的界限。
    *   **建議**：根據您監控的 Excel 檔案的典型大小分佈進行調整。如果大多數檔案都在 5MB 以下，可以適當調低到 5；如果有很多超大型檔案（例如 50MB 以上），可以調高到 20 或 30，以更好地利用稀疏輪詢的優勢。

*   **`DENSE_POLLING_INTERVAL_SEC`** (整數, 預設 `10`)
    *   **作用**：當檔案大小**小於** `POLLING_SIZE_THRESHOLD_MB` 時，系統進行密集輪詢的間隔時間（單位：秒）。
    *   **詳細解釋**：對於小型檔案，寫入操作通常很快完成。較短的間隔可以更快地確認檔案穩定，並在使用者連續儲存時更快地捕捉到最終狀態。
    *   **建議**：如果您的檔案普遍較小且對即時性要求高，可以適當縮短此間隔。但過短可能導致不必要的 CPU 消耗。

*   **`SPARSE_POLLING_INTERVAL_SEC`** (整數, 預設 `15`)
    *   **作用**：當檔案大小**大於或等於** `POLLING_SIZE_THRESHOLD_MB` 時，系統進行稀疏輪詢的間隔時間（單位：秒）。
    *   **詳細解釋**：對於大型檔案，寫入操作可能需要更長時間，頻繁檢查會增加磁碟 I/O 負擔。較長的間隔可以減少不必要的頻繁檢查，降低系統負載，同時給予檔案足夠的時間完成寫入。
    *   **建議**：如果您的檔案普遍較大，可以適當延長此間隔，以減少系統資源佔用。

*   **`MEMORY_LIMIT_MB`** (整數, 預設 `2048`)
    *   **作用**：設定系統在處理 Excel 檔案時允許的最大記憶體使用量（單位：MB）。如果記憶體使用量超過此閾值，系統會暫停處理並嘗試釋放記憶體。
    *   **詳細解釋**：這是系統的「記憶體安全閥」。即使使用了 `read_only` 模式，處理極端複雜或損壞的 Excel 檔案仍可能導致記憶體飆升。這個閾值可以防止程式耗盡系統記憶體，導致整個電腦卡死。
    *   **建議**：根據您系統的可用記憶體和監控檔案的典型大小進行調整。如果您的電腦記憶體較小（例如 4GB），可以適當調低；如果記憶體充裕（例如 16GB 或更多），可以適當調高以減少因記憶體限制而導致的暫停。

*   **`DEBOUNCE_INTERVAL_SEC`** (整數, 預設 `2`)
    *   **作用**：設定防抖動的間隔時間（單位：秒）。在檔案被修改後，如果在此時間內再次收到修改事件，則會忽略後續事件，直到該間隔結束。
    *   **詳細解釋**：這是過濾「事件風暴」的第一道防線。它確保了單次 Excel 儲存操作（可能觸發多個文件系統事件）只會被處理一次。
    *   **建議**：通常 1-3 秒是比較合理的範圍。如果您的 Excel 儲存操作特別慢，或者您發現仍然有重複事件被處理，可以適當增加這個值。但過大可能導致變更響應延遲。

### 5.3 UI 與互動相關：控制使用者介面行為

這些變數控制黑色控制台的行為和使用者互動體驗，讓您可以根據自己的偏好調整系統的「可見性」和「侵入性」。

*   **`ENABLE_BLACK_CONSOLE`** (布林值, 預設 `True`)
    *   **作用**：控制是否啟用並顯示黑色控制台視窗。
    *   **詳細解釋**：這個控制台是系統運行狀態和變更日誌的即時顯示窗口。
    *   **建議**：在開發和調試階段，或者您希望即時觀察系統運行狀態時，保持 `True`。在生產環境中，如果系統作為後台服務運行，不需要即時視覺化輸出，可以設定為 `False`，此時日誌將只寫入 CSV 檔案。

*   **`CONSOLE_POPUP_ON_COMPARISON`** (布林值, 預設 `True`)
    *   **作用**：當偵測到 Excel 檔案變更並顯示比較結果時，黑色控制台視窗是否會自動彈出到最上層。
    *   **詳細解釋**：這是一個「提醒」功能。當有重要變更發生時，即使控制台被其他窗口遮擋或最小化，它也會自動彈出並引起您的注意。
    *   **建議**：如果您希望在變更發生時立即引起使用者注意，請保持 `True`。

*   **`CONSOLE_ALWAYS_ON_TOP`** (布林值, 預設 `False`)
    *   **作用**：控制黑色控制台視窗是否始終保持在其他應用程式視窗之上。
    *   **詳細解釋**：如果設定為 `True`，控制台將會像一個「浮動窗口」一樣，永遠顯示在所有其他窗口的最前面，即使您點擊其他應用程式，它也不會被遮擋。
    *   **建議**：通常應保持 `False`，以避免干擾其他工作。只有在極端需要持續監控，且控制台內容對您當前工作至關重要時，才設定為 `True`。

### 5.4 其他重要變數：系統核心配置

這些變數配置了系統的核心行為，包括監控範圍、日誌儲存位置、支援的檔案類型等。

*   **`WATCH_FOLDERS`** (列表, 預設 `["C:\Users\user\Desktop\Test"]`)
    *   **作用**：定義了系統需要監控的資料夾路徑列表。系統會遞迴監控這些資料夾及其所有子資料夾中的所有 Excel 檔案。
    *   **詳細解釋**：這是您告訴系統「去哪裡看」的關鍵配置。您可以指定一個或多個資料夾。
    *   **建議**：請務必將此設定為您實際需要監控的資料夾的**絕對路徑**。確保系統有權限讀取這些資料夾。

*   **`LOG_FOLDER`** (字串, 預設 `r"C:\Users\user\Desktop\watchdog\log_folder"`)
    *   **作用**：定義了所有日誌檔案（包括基準線檔案和 CSV 變更日誌）的儲存路徑。
    *   **詳細解釋**：所有由系統生成的數據（除了快取文件）都會儲存在這裡。
    *   **建議**：確保該路徑存在且系統有寫入權限。建議選擇一個有足夠儲存空間的磁碟位置。

*   **`CSV_LOG_FILE`** (字串, 自動生成)
    *   **作用**：這是最終的 Excel 變更日誌檔案的路徑。其名稱會包含日期，例如 `excel_change_log_20231027.csv.gz`。
    *   **詳細解釋**：這個變數是根據 `LOG_FOLDER` 和當前日期自動生成的，它確保了每天的變更日誌都會儲存在一個獨立的、帶有日期標識的壓縮文件中。
    *   **注意**：這個變數是自動生成的，通常**不需要手動修改**。

*   **`SUPPORTED_EXTS`** (元組, 預設 `('.xlsx', '.xlsm')`)
    *   **作用**：定義了系統支援並會進行監控的 Excel 檔案副檔名。
    *   **詳細解釋**：系統只會處理這些副檔名的檔案。
    *   **建議**：如果您的 Excel 檔案使用了其他副檔名（例如舊版的 `.xls`，雖然 `openpyxl` 不直接支援，但如果未來有其他解析器集成），或者您希望監控其他基於 ZIP 的 Office 檔案（如 `.docx`, `.pptx`，在擴展解析器後），可以將其添加到此元組中。

*   **`WHITELIST_USERS`** (列表, 預設 `['ckcm0210', 'yourwhiteuser']`)
    *   **作用**：定義了一個使用者白名單。如果啟用了相關功能（例如 `LOG_WHITELIST_USER_CHANGE`），只有這些使用者對 Excel 檔案的變更會被記錄或觸發特定行為。
    *   **詳細解釋**：這是一個基於用戶的過濾器。在某些場景下，您可能只關心特定關鍵用戶的變更，而忽略其他用戶的修改。
    *   **建議**：根據您的團隊成員或需要追蹤的特定使用者進行配置。如果不需要此功能，可以將其留空 `[]`。

*   **`AUTO_UPDATE_BASELINE_AFTER_COMPARE`** (布林值, 預設 `True`)
    *   **作用**：控制在每次比較後，如果發現有變更，系統是否自動更新該檔案的基準線。
    *   **詳細解釋**：這是確保基準線始終反映最新狀態的關鍵。如果為 `True`，每次變更被記錄後，新的檔案狀態就會成為新的基準線。
    *   **建議**：通常應保持 `True`，以確保基準線始終是最新的，從而能夠準確追蹤後續變更。如果設定為 `False`，則需要手動觸發基準線更新，這會導致變更追蹤不準確，因為系統會一直與舊的基準線進行比對。

*   **`DEFAULT_COMPRESSION_FORMAT`** (字串, 預設 `'lz4'`)
    *   **作用**：設定基準線檔案預設使用的壓縮格式。可選值包括 `'lz4'`, `'zstd'`, `'gzip'`。
    *   **詳細解釋**：這決定了基準線檔案的儲存效率和讀寫速度。
    *   **建議**：`'lz4'` 提供最佳的讀寫速度，適合頻繁變更的檔案。`'zstd'` 提供更好的壓縮率，適合歸檔。`'gzip'` 則提供最佳的相容性。

*   **`ENABLE_ARCHIVE_MODE`** (布林值, 預設 `True`)
    *   **作用**：控制是否啟用基準線歸檔模式。啟用後，長時間未更新的基準線會被自動轉換為高壓縮率格式。
    *   **詳細解釋**：這是一個智慧的儲存優化功能，用於管理歷史基準線。
    *   **建議**：對於長期運行且監控大量檔案的系統，啟用此功能可以有效節省磁碟空間。

*   **`ARCHIVE_AFTER_DAYS`** (整數, 預設 `7`)
    *   **作用**：當 `ENABLE_ARCHIVE_MODE` 為 `True` 時，設定基準線檔案在多少天後會被視為「舊」檔案並觸發歸檔。
    *   **詳細解釋**：這個值決定了「冷數據」的定義。
    *   **建議**：根據您對歷史資料的存取頻率和磁碟空間的考量進行調整。如果希望更快地釋放空間，可以縮短天數；如果希望歷史數據保持在快速存取格式更長時間，可以延長天數。