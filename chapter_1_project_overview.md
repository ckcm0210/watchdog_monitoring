# Excel 變更監控系統：技術深度解析

## 第一章：專案概覽與核心理念 (Chapter 1: Project Overview & Core Philosophy)

### 1.1 專案目標：解決什麼問題？

在高強度、協作性的商業環境中，Excel 檔案不僅僅是電子表格，它們是動態的、不斷演進的資料模型、財務報告和營運儀表板。它們承載著企業的關鍵數據和業務邏輯。然而，Excel 的普及性也帶來了一個巨大的挑戰：**變更管理的混亂**。當多個使用者在不同的時間對同一個或多個相互關聯的 Excel 檔案進行修改時，以下問題變得極為突出，就像一個隱形的「數據黑洞」，吞噬著時間和資源：

*   **變更的不透明性**：想像一下，一個重要的財務報表，昨天還是這個數字，今天卻變了。誰改的？什麼時候改的？改了哪個儲存格？從什麼改成了什麼？一個關鍵公式的微小變動，或是一個數值的無心之失，都可能導致連鎖反應，其後果難以追蹤，就像在迷霧中尋找真相。傳統上，我們可能需要手動打開兩個版本的 Excel 檔案，然後逐個儲存格地比對，這不僅耗時耗力，而且極易出錯。
*   **缺乏審計追蹤**：傳統的檔案系統（例如 Windows 的檔案總管）只能告訴我們檔案的最後修改時間，以及是誰最後儲存了這個檔案。但它無法提供一個清晰、結構化的「變更日誌」，告訴我們檔案內部具體發生了什麼變化。這使得合規性審查（例如，金融行業對數據變更的嚴格要求）和錯誤排查變得異常困難。當數據出現問題時，我們無法快速定位到問題的源頭和責任人。
*   **協作衝突**：當一個檔案被多人頻繁修改時，很容易發生版本覆蓋或資料不一致的問題。例如，兩個人同時打開同一個 Excel 檔案，各自修改了一部分，然後先後儲存。後儲存的人可能會覆蓋掉先儲存的人的修改，導致數據丟失。尤其是在處理含有外部連結 (External Links) 的複雜工作簿時，這種衝突會更加複雜，因為一個檔案的變更可能會影響到其他多個檔案。
*   **效能瓶頸**：手動比對大型 Excel 檔案的變更，不僅耗時耗力，而且極易出錯。對於包含數十個工作表、數萬行數據的 Excel 檔案，人工比對幾乎是不可能完成的任務。即使使用 Excel 內建的比較工具，也往往效率低下，無法提供足夠詳細的變更信息。

本專案（以下簡稱 "Excel Monitor"）的誕生，正是為了解決上述所有痛點。其核心目標是提供一個**自動化、高效、且高度可配置的 Excel 檔案變更監控與審計解決方案**。它就像一個不知疲倦的哨兵，靜默地守護在指定的資料夾之上，能夠：

1.  **即時捕捉**任何對 Excel 檔案的修改。這意味著一旦檔案被儲存，系統就能立即感知到。
2.  **精準識別**變更的具體內容，包括數值變化、公式修改、儲存格的新增與刪除。它不僅知道「檔案變了」，更知道「哪裡變了，怎麼變的」。
3.  **智慧分析**變更的類型，區分直接的人為修改（例如，直接輸入一個數字）和間接的公式計算結果（例如，公式引用的儲存格變了，導致公式結果也變了）。這種區分對於理解變更的「原因」至關重要。
4.  **生成結構化日誌**，為每一次有意義的變更都打上時間戳、記錄作者，並存檔備查。這些日誌是可讀的、可分析的，為數據審計提供了堅實的基礎。
5.  **在高效能與低資源佔用之間取得平衡**，即使在監控大量或大型檔案時，也能保持系統的穩定運行，不會拖慢您的電腦速度。

### 1.2 核心設計理念：為何選擇「基準線比對」模型？

要追蹤變更，最直觀的想法可能是直接掛鉤到 Excel 應用程式本身，例如通過 VBA 宏或 COM 組件。然而，這種方法不僅技術複雜度高、開發成本巨大、侵入性強（需要修改 Excel 檔案本身或依賴特定的 Excel 版本），而且極度不穩定，容易受到 Office 版本、外掛程式和作業系統更新的影響。一旦 Excel 應用程式本身發生變化，您的監控系統可能就會失效。

因此，Excel Monitor 選擇了一條更為穩健、可靠且通用的道路：**非侵入式的「基準線比對」(Baseline Comparison) 模型**。

這個模型的核心理念極為優雅，就像我們在日常生活中拍照記錄變化一樣：**任何狀態的變更，都可以通過與其前一個穩定狀態的快照進行比對來確定。**

在我們的專案中，這個「快照」被稱為**基準線 (Baseline)**。您可以把它想像成一個 Excel 檔案在某個特定時間點的「DNA 圖譜」或「指紋」。其運作方式如下：

1.  **首次建立 (Initial Baseline)**：當一個新的 Excel 檔案首次被納入監控時，系統會完整地讀取其所有工作表、所有儲存格的數值和公式，並將這些資料以一種結構化的方式（例如 JSON 格式）序列化後，儲存為一個特殊的基準線檔案。這個檔案就成為了該 Excel 檔案在「初始狀態」下的權威記錄，就像您第一次為一個物品拍下的「標準照」。
2.  **變更觸發 (Modification Trigger)**：當作業系統偵測到該 Excel 檔案被修改並儲存時，監控系統會被喚醒。這就像您發現物品被移動或改變了位置。
3.  **即時比對 (Live Comparison)**：系統會立即讀取被修改後的檔案內容（我們稱之為「當前狀態」），並將其與之前儲存的基準線檔案進行逐一比對。這就像您將物品的「當前照片」與「標準照」進行比對，找出哪裡不一樣。
4.  **差異分析 (Delta Analysis)**：比對的結果——即「差異 (Delta)」——就是這次檔案變更的全部內容。系統會精確地分析這些差異，找出哪些儲存格被修改、新增或刪除，以及具體的「舊值」和「新值」。
5.  **日誌記錄與基準線更新 (Logging & Baseline Update)**：分析出的有意義的變更會被記錄到一個易於閱讀和分析的 CSV 日誌中。隨後，系統會用「當前狀態」的內容，生成一個**新的基準線檔案**，覆蓋掉舊的基準線。這樣，當前狀態就變成了下一次比對的「前一個穩定狀態」。這就像您在物品改變後，重新拍一張新的「標準照」，以便下次比對。

這個模型的巨大優勢在於：

*   **解耦與獨立**：它完全不依賴 Excel 應用程式本身。這意味著無論檔案是通過哪個版本的 Excel、WPS 還是其他程式修改的，只要最終的檔案內容發生了變化，系統都能準確捕捉。這使得系統具有極高的通用性和適應性。
*   **高效與精準**：通過結構化的資料比對，系統可以極快地定位到每一個變更的細節，例如「Sheet1!A1 從 '舊值' 變成了 '新值'」。這遠比像素級的螢幕比對或二進位的檔案比對更高效、更具可讀性。
*   **健壯與可靠**：即使在程式中斷或檔案鎖定的情況下，基準線作為一個持久化的狀態記錄，也能確保系統在恢復後可以從一個已知的、穩定的狀態繼續開始工作。它提供了一個「安全網」，保證數據的完整性和可追溯性。

### 1.3 技術棧概覽：Python、Watchdog、Openpyxl 等核心函式庫的作用

Excel Monitor 的強大功能，建立在一系列精心挑選的、成熟可靠的 Python 函式庫之上。這些函式庫就像是系統的「積木」，各自承擔著特定的功能，共同構建起整個監控系統：

*   **Python 3**：作為專案的基石，Python 的易讀性、簡潔的語法、豐富的生態系統和強大的標準庫，為快速開發和系統整合提供了堅實的基礎。它使得開發者可以專注於業務邏輯，而不是底層的複雜性。
*   **`watchdog`**：這是實現即時檔案監控的核心「感測器」。它提供了一套跨平台的 API，可以與作業系統內建的檔案系統事件介面（如 Windows 的 `ReadDirectoryChangesW`、Linux 的 `inotify`）進行互動。這意味著，當您在監控的資料夾中對 Excel 檔案進行任何操作（例如儲存、刪除、重新命名）時，`watchdog` 能夠立即收到作業系統發出的通知，就像一個靈敏的警報系統。
*   **`openpyxl`**：這是專案與 Excel 檔案（`.xlsx`, `.xlsm`）互動的「翻譯官」。它允許我們在不啟動 Excel 應用程式的情況下，直接讀取和解析 Excel 檔案的內部結構。您可以把它想像成一個能夠直接「閱讀」Excel 檔案內部「語言」的工具。通過 `openpyxl`，我們可以提取出每個工作表中的儲存格數據、公式、格式，甚至檔案的元數據（例如最後修改作者）。專案中的 `excel_parser.py` 模組對 `openpyxl` 進行了深度封裝和優化，以應對處理大型 Excel 檔案時可能遇到的效能挑戰。
*   **`lz4`, `zstandard`, `gzip`**：這三個函式庫是實現智慧壓縮策略的「壓縮機」。它們分別代表了三種不同特性的壓縮演算法，使得專案可以根據需求（例如，對常用檔案使用速度更快的 LZ4，對長期歸檔使用壓縮率更高的 Zstd）靈活地管理基準線檔案的儲存。這不僅節省了磁碟空間，更重要的是，通過壓縮和解壓縮，可以顯著提升基準線檔案的讀寫速度，從而加速整個比對過程。

### 1.4 系統架構圖：高層次流程

為了更直觀地理解系統的運作方式，以下是一個高層次的流程圖。您可以將其視為 Excel Monitor 內部各個模組協同工作的「路線圖」：

```mermaid
graph TD
    subgraph "使用者操作"
        A[使用者儲存 Excel 檔案]
    end

    subgraph "檔案系統層"
        B{檔案系統事件}
        A --> B
    end

    subgraph "監控核心 (core/watcher.py)"
        C[Watchdog 監聽器]
        D{on_modified 事件}
        E[防抖動 & 輪詢檢查]
        B --> C --> D --> E
    end

    subgraph "比較與分析核心 (core/comparison.py)"
        F[比較變更]
        G[分析有意義的變更]
        H[日誌記錄 (CSV)]
        I[更新基準線]
        E --> F
        F --> G
        G --> H
        G --> I
    end

    subgraph "資料解析層 (core/excel_parser.py)"
        J[使用 Openpyxl 解析 Excel]
        F --> J
    end

    subgraph "基準線存儲 (core/baseline.py)"
        K[讀取舊基準線]
        L[寫入新基準線 (含壓縮)]
        F --> K
        I --> L
    end

    subgraph "使用者介面 (ui/console.py)"
        M[黑色控制台顯示結果]
        F --> M
    end
```

這個流程清晰地展示了從一個簡單的「儲存」動作開始，如何在系統內部觸發一系列連鎖反應，最終完成變更的捕捉、分析、記錄和基準線的更新。每一個方框都代表了系統的一個關鍵模組或步驟，箭頭則表示數據和控制流的方向。接下來的章節，我們將深入到每一個環節，探索其背後的技術實現與設計巧思。